## 问题分析

1. **Dify API调用超时**：当调用`/api/submit-text`端点时，返回504网关超时错误，但提示"请求可能已在Dify后台成功处理"
2. **日志记录不足**：服务器没有将详细日志写入文件，导致难以调试
3. **错误处理需要优化**：虽然有基本的错误处理，但需要更完善的重试机制和状态检查

## 解决方案

### 1. 优化Dify API调用
- **增加重试机制**：对504等临时错误实现自动重试
- **调整超时设置**：优化超时参数，平衡响应速度和成功率
- **改进请求格式验证**：确保发送给Dify的请求格式完全符合要求

### 2. 增强日志记录
- **添加文件日志**：将详细日志写入文件，包括请求和响应信息
- **优化日志格式**：使用结构化日志，便于分析和调试
- **增加关键节点日志**：在API调用的关键节点添加详细日志

### 3. 改进错误处理
- **细化错误分类**：更精确地识别不同类型的Dify API错误
- **提供更有用的错误信息**：返回更详细的错误原因和解决方案
- **添加状态检查端点**：允许客户端检查请求状态

### 4. 测试和验证
- **编写测试脚本**：创建自动化测试脚本，验证API调用
- **模拟不同场景**：测试超时、错误响应等场景
- **性能测试**：测试API在不同负载下的表现

## 实施步骤

1. **修改`sendToDifyWorkflow`函数**：添加重试机制和优化超时设置
2. **添加日志中间件**：将日志写入文件
3. **改进错误处理逻辑**：细化错误分类和信息
4. **创建测试脚本**：验证API调用
5. **部署和测试**：运行测试并验证修复效果

## 预期结果

- Dify API调用成功率提高
- 详细的日志记录便于调试
- 更友好的错误信息
- 更健壮的API交互机制