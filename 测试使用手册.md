# 🧪 测试使用手册

## 快速开始

### 运行交互式测试
```bash
./运行测试.sh
```

这会启动一个交互式菜单，让您选择要运行的测试类型。

---

## 测试类型

### 1. 快速测试 ⚡
**用途**: 快速验证基本功能是否正常

**运行时间**: ~30秒

**命令**:
```bash
npm run test:quick
# 或
node test-local-agent.js
```

**测试内容**:
- ✅ 加载知识库
- ✅ 查询术语
- ✅ 预处理文本
- ✅ 执行翻译（需要API密钥）

---

### 2. 综合测试 🔍
**用途**: 全面测试系统的鲁棒性

**运行时间**: ~2分钟

**命令**:
```bash
npm run test
# 或
node tests/comprehensive-test.js
```

**测试类别**:
1. **单元测试** (7个测试)
   - 知识库加载和查询
   - 预处理功能
   - 边界条件

2. **边界测试** (7个测试)
   - 空字符串
   - 超长字符串
   - 特殊字符
   - 混合语言

3. **性能测试** (4个测试)
   - 加载性能 (<100ms)
   - 查询性能 (<10ms)
   - 批量查询
   - 预处理性能

4. **压力测试** (3个测试)
   - 连续查询
   - 内存稳定性
   - 缓存有效性

5. **API测试** (3个测试)
   - 健康检查
   - 提交文本
   - 历史记录

6. **错误处理测试** (3个测试)
   - 空文本
   - 无效参数
   - API错误

---

### 3. 压力测试 💪
**用途**: 测试系统在高负载下的表现

**运行时间**: ~5-10分钟

**命令**:
```bash
npm run test:stress
# 或
node tests/stress-test.js
```

**测试场景**:
1. **健康检查压力测试**
   - 持续: 30秒
   - 并发: 20个请求
   - 目标: >1000 RPS

2. **提交文本压力测试**
   - 持续: 60秒
   - 并发: 10个请求
   - 目标: >100 RPS

3. **混合负载测试**
   - 持续: 60秒
   - 并发: 15个请求
   - 测试: 多种API混合

4. **高并发测试**
   - 持续: 30秒
   - 并发: 50个请求
   - 目标: 测试极限

**性能指标**:
- RPS (请求/秒)
- 响应时间 (P50, P95, P99)
- 成功率
- 错误率

---

### 4. 完整测试 📊
**用途**: 运行所有测试，生成完整报告

**运行时间**: ~10-15分钟

**命令**:
```bash
npm run test:all
```

这会依次运行：
1. 快速测试
2. 综合测试
3. 压力测试

---

## 测试前准备

### 必需条件
1. **启动后端服务器**
   ```bash
   npm run server
   ```

2. **确保端口可用**
   - 后端: 3001
   - 前端: 5173 (部分测试需要)

### 可选配置
- **Claude API密钥**: 测试完整翻译功能
- **飞书配置**: 测试真实知识库

---

## 测试结果解读

### 测试报告示例

```
═══════════════════════════════════════════════════════════
📊 测试报告
═══════════════════════════════════════════════════════════

✅ 通过: 25
❌ 失败: 2
⏭️  跳过: 0
📈 成功率: 92.59%

⏱️  平均耗时: 45.23ms
⏱️  总耗时: 1220ms
```

### 成功标准

#### 快速测试
- ✅ 通过率: 100% (有API密钥) 或 75% (无API密钥)
- ✅ 平均耗时: <100ms

#### 综合测试
- ✅ 通过率: >90%
- ✅ 性能测试: 100%通过
- ✅ 错误率: <5%

#### 压力测试
- ✅ RPS: >100 (提交文本)
- ✅ 成功率: >95%
- ✅ P95响应时间: <500ms
- ✅ 内存增长: <100MB

---

## 常见测试场景

### 场景1: 开发后验证
```bash
# 每次代码改动后运行
npm run test:quick
```

### 场景2: 功能完成验证
```bash
# 完成新功能后运行
npm run test
```

### 场景3: 发布前验证
```bash
# 发布前运行完整测试
npm run test:all
npm run test:stress
```

### 场景4: 性能调优
```bash
# 只运行压力测试
npm run test:stress
```

---

## 测试失败排查

### 常见失败原因

#### 1. 服务器未启动
**症状**: "ECONNREFUSED"

**解决**:
```bash
npm run server
```

#### 2. API密钥未配置
**症状**: "Claude API密钥未配置"

**解决**: 这是预期行为，配置`.env`中的`ANTHROPIC_API_KEY`

#### 3. 端口被占用
**症状**: "EADDRINUSE"

**解决**:
```bash
# 查找占用端口的进程
lsof -i :3001

# 终止进程
kill -9 <PID>
```

#### 4. 内存不足
**症状**: 压力测试失败

**解决**: 减少并发数或测试时长

---

## 持续集成

### GitHub Actions

创建 `.github/workflows/test.yml`:

```yaml
name: 测试

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: 设置 Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
    
    - name: 安装依赖
      run: npm install
    
    - name: 启动服务器
      run: npm run server &
      
    - name: 等待服务器启动
      run: sleep 5
    
    - name: 运行测试
      run: npm run test
    
    - name: 上传测试报告
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: test-results/
```

---

## 自定义测试

### 添加新测试

编辑 `tests/comprehensive-test.js`:

```javascript
const myTests = [
  test('我的新测试', async () => {
    // 测试代码
    const result = await myFunction()
    expect(result).toBeDefined()
  })
]

// 添加到测试套件
const testSuites = [
  // ...existing tests
  { name: '我的测试', tests: myTests }
]
```

### 配置压力测试

编辑 `tests/stress-test.js`:

```javascript
const stressTest = new StressTest({
  duration: 120000,  // 2分钟
  concurrency: 20,   // 20并发
  rampUp: 10000      // 10秒启动时间
})
```

---

## 测试数据

### 测试文本样本

```javascript
// 短文本
const shortText = "测试文本"

// 中等文本
const mediumText = "地图质量确认。机器人定位丢失。运行停止。"

// 长文本
const longText = "测试文本。".repeat(1000)

// 特殊字符
const specialText = "测试@#$%文本！？。"

// 混合语言
const mixedText = "这是中文 This is English 混合文本"
```

### 测试术语

```javascript
const testTerms = [
  { original: '激光雷达', translation: 'LiDAR' },
  { original: '建图', translation: 'Mapping' },
  { original: '定位', translation: 'Localization' }
]
```

---

## 性能基准

### 目标性能

| 操作 | 目标时间 | 实际平均 |
|------|---------|---------|
| 加载知识库 | <100ms | ~15ms |
| 查询术语 | <10ms | ~2ms |
| 预处理文本 | <500ms | ~150ms |
| 简单翻译 | <5s | N/A |

### 压力测试基准

| 指标 | 目标 | 备注 |
|------|------|------|
| 健康检查 RPS | >1000 | 轻量级请求 |
| 提交文本 RPS | >100 | 复杂请求 |
| P95响应时间 | <500ms | 95%请求 |
| 成功率 | >95% | 压力下 |
| 内存增长 | <100MB | 100次操作 |

---

## 故障模拟

### 测试API失败

```javascript
// 模拟API超时
process.env.ANTHROPIC_API_KEY = 'invalid-key'

// 模拟网络错误
// 断开网络连接后运行测试
```

### 测试边界条件

```javascript
// 超大文本
const hugeText = 'a'.repeat(1000000)

// 空文本
const emptyText = ''

// Null值
const nullText = null
```

---

## 最佳实践

### 开发流程

1. **编码前**: 运行快速测试确保环境正常
2. **编码中**: 频繁运行快速测试
3. **编码后**: 运行综合测试
4. **提交前**: 运行完整测试
5. **发布前**: 运行压力测试

### 测试频率

- **每次修改**: 快速测试
- **每天**: 综合测试
- **每周**: 完整测试 + 压力测试
- **发布前**: 所有测试

### 测试覆盖

- **核心功能**: 100%
- **边界情况**: >90%
- **错误处理**: >85%
- **性能**: 100%

---

## 问题反馈

### 报告Bug

测试失败时，请提供：
1. 测试命令
2. 错误信息
3. 测试报告文件
4. 环境信息 (Node版本, OS)

### 测试报告位置

```
test-results/
└── test-results-1234567890.json
```

查看报告：
```bash
cat test-results/test-results-*.json | jq .
```

---

## 附录

### 测试工具

- **axios**: HTTP请求测试
- **自定义断言**: 轻量级测试断言
- **压力测试框架**: 自定义压力测试工具

### 相关文档

- `测试计划.md` - 完整测试策略
- `测试报告.md` - 系统测试结果
- `README-LOCAL-AGENT.md` - 系统架构

---

**文档版本**: 1.0  
**更新日期**: 2025-11-29  
**维护者**: 开发团队


